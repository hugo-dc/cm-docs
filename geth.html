<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Geth changes - Code Merkleization</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="favicon.svg">
        
        
        <link rel="shortcut icon" href="favicon.png">
        
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        
        <link rel="stylesheet" href="css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="introduction.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="geth.html" class="active"><strong aria-hidden="true">2.</strong> Geth changes</a></li><li class="chapter-item expanded "><a href="schema.html"><strong aria-hidden="true">3.</strong> Schema</a></li><li class="chapter-item expanded "><a href="codetrie.html"><strong aria-hidden="true">4.</strong> CodeTrie</a></li><li class="chapter-item expanded "><a href="fastssz.html"><strong aria-hidden="true">5.</strong> FastSSZ</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">Code Merkleization</h1>

                    <div class="right-buttons">
                        
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="geth-changes"><a class="header" href="#geth-changes">Geth changes</a></h1>
<p>A Geth fork was created and added some features to merkleize contracts when
performing a full sync.</p>
<p>Changes are described below.</p>
<h2 id="new-modules"><a class="header" href="#new-modules">New modules</a></h2>
<p>Two new modules are introduced to the Geth code base:</p>
<ul>
<li><code>ssz</code> (<code>codetrie/ssz</code>): contains the <a href="./schema.html">schema</a> defined for the code tree.</li>
<li><code>codetrie</code>: contains the <a href="./codetrie.html">logic</a> needed to manipulate the tree.</li>
</ul>
<h2 id="codemerkleization-flag"><a class="header" href="#codemerkleization-flag">codemerkleization flag</a></h2>
<p>changes: </p>
<ul>
<li><code>cmd/geth/chaincmd.go</code></li>
<li><code>cmd/geth/usage.go</code></li>
<li><code>cmd/geth/main.go</code></li>
<li><code>cmd/utils/flags.go</code></li>
<li><code>eth/gen_config.go</code></li>
<li><code>eth/backend.go</code></li>
<li><code>eth/config.go</code></li>
</ul>
<p>A new flag was added in order to indicate geth we want to analyze how the
contracts in a block would be merkleized and get the size of proofs required
for the contracts in each block.</p>
<h2 id="state_processor"><a class="header" href="#state_processor">state_processor</a></h2>
<p>path: <code>core/state_processor.go</code></p>
<p>One of the main <a href="#changed-code">changes</a> in Geth is in the <code>state_processor</code>.
In function <code>Process</code> a <a href="./codetrie.html#newcontractbag">new &quot;Contract Bag&quot;</a> is
created. A <code>ContractBag</code> is a map where the key is the <strong>code hash</strong> and the
value is the <strong>contract code</strong>, this avoids duplicating identical contracts
with the same bytecode. </p>
<p>Then, each transaction in the block is applied. When the <a href="#run-evm-interpreter">EVM
Interpreter</a> is <em>executing</em> the opcodes, collects
information about touched opcodes and which chunks the opcodes belong.</p>
<p>After contracts bytecode and touched opcodes/chunks are collected, the stats
are calculated by calling the
<a href="./codetrie.html#stats-contractbag-method"><code>bag.Stats()</code></a> method, this method
merkleizes the contract, and generates the proof needed for that contract in
that specific block. The proof consists in indices, hashes, zero levels and
leaves. And the sum of those values for all the contracts is considered as
a metric of &quot;proof size&quot; of the block. Indices, Hashes, and Zero Levels are
serialized as RLP and the RLP size is used as another measure of the proof
size.</p>
<p>The results are stored in a <code>csv</code> (<code>cm-result.csv</code>) file with the following
fields:</p>
<ul>
<li><strong>Block number</strong></li>
<li><strong>Code size</strong>: The sum of all contract's bytecode size in the block.</li>
<li><strong>Proof size</strong>: The sum of all indices, zero levels, hashes, and leaves.</li>
<li><strong>RLP Size</strong>: Size of the RLP-encoded <a href="./fastssz#compressedmultiproof">Compressed Multiproof</a> (indices, zero levels, hashes and leaves.)</li>
<li><strong>UnRLPSize</strong>: Size of the uncompressed-RLP Encoded
<a href="./fastssz#multiproof">Proof</a> (Indices, Leaves, Hashes) </li>
<li><strong>SnappySize</strong>: Size of the Indices, Zero Levels, Hashes, and Leaves, serialized as RLP and then compressed using Snappy compression.</li>
<li><strong>Total indices</strong></li>
<li><strong>Total zero levels</strong></li>
<li><strong>Total hashes</strong></li>
<li><strong>Total Leaves</strong></li>
</ul>
<h2 id="run-evm-interpreter"><a class="header" href="#run-evm-interpreter">Run (EVM Interpreter)</a></h2>
<p>path: <code>core/vm/interpreter.go</code></p>
<p>When evaluating the contract code in the <code>Run</code> function, checks if the
<code>-codemerkleization</code> flag is set, and <code>ContractBag</code> was initialized correctly,
also avoids merkleizing code which does not corresponds to a contract (i.e.
contract creation code).</p>
<p><a href="./codetrie.html#get-contractbag-method">Retrieve</a> the <code>Contract</code> from the
contract bag, otherwise, if the contract does not exist in the contract bag
yet, a new <code>Contract</code> object is created.</p>
<p><a href="./codetrie.html#touchpc-contract-method">Marks the chunk</a> corresponding to the current opcode at the current Program Counter (pc) as &quot;touched&quot;.</p>
<p>If the current opcode is <code>CODECOPY</code> it will also <a href="./codetrie.html#touchrange-contract-method">touch the
range</a> of opcodes being copied.</p>
<p>When the current opcode is <code>EXTCODECOPY</code>, it will also retrieve the
code for the &quot;external&quot; contract code we want to copy 
and that code will be <a href="./codetrie.html#touchrange-contract-method">marked as touched</a>.</p>
<p>In the case if init code (contract creation code) it checks if the total length
of the code size is greater than <code>0xc000</code> (49152), if it is greater it will be
<a href="./codetrie.html#addlargeinit-contractbag-method">Added</a> to a map in
<code>ContractBag</code>, where the key is the <code>codeHash</code> of the contract and the value is
its total code size. </p>
<h2 id="added-code"><a class="header" href="#added-code">Added code</a></h2>
<p>This is the directory tree for the new code added to Geth</p>
<pre><code>├── codetrie
│   ├── ssz
│   │   ├── types_encoding.go
│   │   └── types.go
│   ├── bin_hex_test.go
│   ├── codetrie.go
│   ├── codetrie_test.go
│   ├── contract.go
│   ├── op.go
│   ├── ssz_test.go
│   └── transition.go
</code></pre>
<h2 id="changed-code"><a class="header" href="#changed-code">Changed code</a></h2>
<pre><code>├── cmd
│   ├── geth
│   │   ├── chaincmd.go
│   │   ├── main.go
│   │   └── usage.go
│   └── utils
│       ├── flags.go
├── core
│   ├── ...
│   ├── state_processor.go
│   ├── ...
├── eth
│   ├── backend.go
│   ├── config.go
│   ├── gen_config.go
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="introduction.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="schema.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="introduction.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="schema.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
